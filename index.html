<!--
python -m SimpleHTTPServer
-->
<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>My First Game with Easel</title>
    <link href="css/main.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
    <script src="http://code.createjs.com/createjs-2014.12.12.min.js"></script>

    <script>

      // defaults
      var numOfDaleks = 6;

      var canvas, stage, bg, score, bitmap;
      var bmpList = [];
      var play, gameTxt;
      var mouseTarget, clicked, mouseBp;
      var explosion;

      var audioPath = 'assets/';
      var sounds = [
          {id:'sonic', src:'sonic.mp3'},
          {id:'exterminate', src:'exterminate.mp3'},
          {id:'theme', src:'theme.mp3'}
      ];

      createjs.Sound.alternateExtensions = ["mp3"];

      function init() {
        canvas = document.getElementById('canvas');
        scoreP = document.getElementById('score');
        stage = new createjs.Stage(canvas);
        score = 0;

        bg = new Image();
        bg.src = 'assets/space.jpg';
        bg.onload = setBG;

        stage.canvas.style.cursor = 'none';
        
        stage.addEventListener('stagemousemove', moveHandler);

        canvas.onmousedown = onMouseDown;
        canvas.onmouseup = onMouseUp;

        var image = new Image();
        image.src = 'assets/dalek.png';
        image.onload = createDaleks;

        explosion = new Image();
        explosion.src = 'assets/explosion.png';

        mouseBp = new createjs.Bitmap('assets/sonic.png');
        createjs.Sound.registerSounds(sounds, audioPath);   
        createjs.Sound.addEventListener("fileload", handleLoad);
      };
      
      function handleLoad(event) {
          createjs.Sound.play('theme', {loop:-1});
      }
      
      function moveHandler() {
        mouseBp.x = stage.mouseX - 5;
        mouseBp.y = stage.mouseY - 5;
      };

      function createDaleks(event) {
        var image = event.target;
        var container = new createjs.Container();
        stage.addChild(container);
        var l = numOfDaleks;
        bmpList = [];
        for (i=0;i<l;i++) {
          bitmap = new createjs.Bitmap(image);
          container.addChild(bitmap);
          bitmap.name = "dalek" + i;
          resetEnemy(bitmap);
          bitmap.regX = bitmap.image.width/2|0;
          bitmap.regY = bitmap.image.height/2|0;
          bitmap.mouseEnabled = true;
          bmpList.push(bitmap)
        }
        stage.addChild(mouseBp);
        gameOver();
        createjs.Ticker.addEventListener('tick', handleTick);
      };

      function setBG(event) {
        var bgrnd = new createjs.Bitmap(bg);
        stage.addChild(bgrnd);
        stage.update();
        createDaleks;
      };

      function resetEnemy(dalek) {
        dalek.x = canvas.width + Math.random()*300;
        dalek.y = (canvas.height - 100) * Math.random()+50;
        dalek.speed = (Math.random()*5)+2;
      };

      function handleTick() {
        //checking clicks
        if (!clicked && stage.mouseX && stage.mouseY) {
          mouseTarget = stage.getObjectUnderPoint(mouseBp.x,mouseBp.y); 
        }

        if (clicked && mouseTarget) {
          var tempText = String(mouseTarget.name);
          tempText = tempText.substring(0,5);
          if (tempText!=null && tempText=='dalek') {
            
            // explosions
            var data = {
              framerate: 10,
              images: [explosion],
              frames: {width:64, height:64, regX:32, regY:32},
              animations: {
                  'explode': [0, 25,null,4]
              }
            }

            var spritesheet = new createjs.SpriteSheet(data);
            var animation = new createjs.Sprite(spritesheet, 'explode');
            animation.x = mouseTarget.x;
            animation.y = mouseTarget.y;
            stage.addChild(animation);
            animation.on("animationend", handleExplosionEnd);
            function handleExplosionEnd(event) {
                if (event.name == "explode") { // For example
                    event.remove();
                    stage.removeChild(animation);
                }
            }

            // play sonic sound
            createjs.Sound.play('sonic');

            // resets
            resetEnemy(mouseTarget);
            score += 50;
            scoreP.innerText = "Score: " + score;
            clicked = false;
          }
        }

        //moving daleks
        if (play == true) {
          var l = bmpList.length;
          for (var i=0;i<l;i++) {
            var bmp = bmpList[i];
            if (bmp.x > -20) {
              bmp.x -= bmp.speed;
            } else {
              gameOver();
              console.log('game over');
            }
          }
        }
        stage.update();
        canvas.onclick = handleClick;
        document.onkeydown = handleKeyDown;
        document.onkeyup = handleKeyUp;
      };

      function handleKeyDown(event) {
        if (event.keyCode == 32) {
          event.preventDefault();
          clicked = true;
        }
      };

      function handleKeyUp(event) {
        if (event.keyCode == 32) {
          event.preventDefault();
          clicked = false;
        }
      };

      function handleClick() {
        canvas.onclick = null;
        stage.removeChild(gameTxt);
        play = true;
      };

      function onMouseDown() {
        if(!e){var e = window.event;}
        clicked = true;
      };

      function onMouseUp() {
        clicked = false;
      };

      function gameOver() {
        createjs.Sound.play('exterminate');
        gameTxt = new createjs.Text('Game Over\n\n', '36px Ariel', '#fff');
        gameTxt.text += 'Click to play again';
        gameTxt.textAlign = "center";
        gameTxt.x = canvas.width/2;
        gameTxt.y = canvas.height/3;
        stage.addChild(gameTxt);
        play = false;
        score = 0;
        var l = bmpList.length;
        for (var i=0;i<l;i++) {
          var bmp = bmpList[i];
          resetEnemy(bmp);
        }
        stage.update();
      };
    </script>
  </head>
  <body onload="init();">
    <p id="score">Score: 0</p>
    <canvas id="canvas" width="860" height="600"></canvas>
  </body>
</html>